<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>ACSC 2023 - Mochi</title><link rel="icon" type="image/png" href=https://github.com/MochiNishimiya/mochinishimiya.github.io/blob/main/favicon.ico?raw&#61;true /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="My writeup for two interesting Reverse challenges I solved in ACSC 2023" />
	<meta property="og:image" content=""/>
	<meta property="og:title" content="ACSC 2023" />
<meta property="og:description" content="My writeup for two interesting Reverse challenges I solved in ACSC 2023" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mochinishimiya.github.io/posts/acsc2023/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-03-01T01:11:28+07:00" />
<meta property="article:modified_time" content="2023-03-01T01:11:28+07:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="ACSC 2023"/>
<meta name="twitter:description" content="My writeup for two interesting Reverse challenges I solved in ACSC 2023"/>
<script src="https://mochinishimiya.github.io/js/feather.min.js"></script>
	
	
        <link href="https://mochinishimiya.github.io/css/fonts.7fa06c2792c8589768ffcdaf014e4bfc7f2ccbfba059f8e87131158970c23ed3.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://mochinishimiya.github.io/css/main.8689881321c3544631bd4e2e14a6acb182a98927569954a5af156c2833fba623.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://mochinishimiya.github.io/css/dark.4bf332c39a21927ebdde34f90f86b9db9b3cf33d14549a5c1b70f6e492b97030.css"   />
	
	
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://mochinishimiya.github.io/">Mochi</a>
	</div>
	<nav>
		
		<a href="/">Home</a>
		
		<a href="/posts">All posts</a>
		
		<a href="/about">About</a>
		
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">ACSC 2023</h1>
			<div class="meta">Posted on Mar 1, 2023</div>
		</div>
		

		<section class="body">
			<h1 id="table-of-contents">Table of Contents</h1>
<ol>
<li><a href="#preface">Preface</a></li>
<li><a href="#pyso-7-solves">pyso</a>
<ol>
<li><a href="#first-look">First look</a></li>
<li><a href="#analyzing-encryption-routine">Analyzing encryption routine</a></li>
<li><a href="#recreate-programs-flow-in-python">Recreate program&rsquo;s flow in Python</a></li>
<li><a href="#decrypting-and-getting-flag">Decrypt and get flag</a></li>
</ol>
</li>
<li><a href="#snake">snake</a>
<ol>
<li><a href="#initial-analysis">Initial analysis</a></li>
<li><a href="#ld_preload-trick-and-further-analysis">LD_PRELOAD trick and further analysis</a></li>
<li><a href="#analyzing-packets-components">Analyzing packet&rsquo;s components</a></li>
<li><a href="#create-a-valid-packet">Create a valid packet</a></li>
</ol>
</li>
</ol>
<h1 id="preface">Preface</h1>
<p>Last week I participated in <strong>Asian Cyber Security Challenge</strong> (ACSC), I managed to get 12th place overall and 1st place in my country as an eligible participant for ICC.</p>
<p><img src="https://i.imgur.com/0ti2FmI.png" alt=""></p>
<p>In all Reverse challenges I solved, <code>pyso</code> and <code>snake</code> are the most interested among them and I think it would be nice to share what I&rsquo;ve done through this writeup.</p>
<h1 id="pyso-7-solves">pyso (7 solves)</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Typical crackme challenge in a CTF. But written in py so it should be harder, right?
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Time to download pyinstaller extractor again.
</span></span></code></pre></div><p>Given file: <a href="https://github.com/MochiNishimiya/mochinishimiya.github.io/raw/main/challenges/ACSC_2023/pyso.tar.gz">pyso.tar.gz</a></p>
<h2 id="first-look">First look</h2>
<p>We&rsquo;re being given <code>main.py</code> and <code>libvalidator</code>. Here&rsquo;s the source code of <code>main.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> libvalidator
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>KEY <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(list(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xf7\x9b\xc3\xcc\x81\x8d\xb9\xd1\x1a\xdd</span><span style="color:#e6db74">K</span><span style="color:#ae81ff">\xc2</span><span style="color:#e6db74">/</span><span style="color:#ae81ff">\x85\xb8</span><span style="color:#e6db74">U&#39;</span>), dtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;uint8&#39;</span>)
</span></span><span style="display:flex;"><span>IV <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(list(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x84\x9a\xa6\xf6\x84</span><span style="color:#e6db74">s</span><span style="color:#ae81ff">\x86\xf4\xb9\xda\xe9\xc6\xca</span><span style="color:#e6db74">@:2&#39;</span>), dtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;uint8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> list(input(<span style="color:#e6db74">&#34;Enter flag: &#34;</span>)<span style="color:#f92672">.</span>encode())
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(flag, dtype<span style="color:#f92672">=</span>np<span style="color:#f92672">.</span>uint8)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> libvalidator<span style="color:#f92672">.</span>fast_len(flag) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">24</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Wrong length!&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(list(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\xef\x1e\xe6\xd9</span><span style="color:#e6db74">jh</span><span style="color:#ae81ff">\xaa\xea\xa6\xfc</span><span style="color:#e6db74">q</span><span style="color:#ae81ff">\x0e</span><span style="color:#e6db74">c</span><span style="color:#ae81ff">\x94\xd7\xc4\xcc\x7f\xe7\xa1\xf3\x9f\xa6</span><span style="color:#e6db74">z&#39;</span>), dtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;uint8&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> libvalidator<span style="color:#f92672">.</span>fast_xor(flag, X)
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> libvalidator<span style="color:#f92672">.</span>fast_rev(flag)
</span></span><span style="display:flex;"><span>flag <span style="color:#f92672">=</span> libvalidator<span style="color:#f92672">.</span>aes_encrypt(flag, KEY, IV)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>E <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(list(<span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x81\xdd\xfc\xfd\xa9\xc1</span><span style="color:#e6db74">LE</span><span style="color:#ae81ff">\xdf</span><span style="color:#e6db74">y</span><span style="color:#ae81ff">\xfd</span><span style="color:#e6db74">0</span><span style="color:#ae81ff">\x06</span><span style="color:#e6db74">f</span><span style="color:#ae81ff">\xa1</span><span style="color:#e6db74">}</span><span style="color:#ae81ff">\xd2\x8c</span><span style="color:#e6db74">%&lt;U</span><span style="color:#ae81ff">\xba</span><span style="color:#e6db74">A</span><span style="color:#ae81ff">\x97</span><span style="color:#e6db74">&#39;</span>), dtype<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;uint8&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> libvalidator<span style="color:#f92672">.</span>fast_cmp(flag, E):
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Correct!&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;Try harder!&#34;</span>)
</span></span></code></pre></div><p>Without <code>libvalidator</code>, this is just a simple reverse challenge with simple operations like xor, rev, aes,&hellip; So I suspect there must be changes in these operations in the library file to make reversers confusing. With this in mind, I started using my favorite tool - IDA Pro, to do initial analysis.</p>
<p>Skimming through functions that are being used in <code>main.py</code>, these five are the most suspicious one in library file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>_pycc_method_aes_encrypt
</span></span><span style="display:flex;"><span>_pycc_method_fast_cmp
</span></span><span style="display:flex;"><span>_pycc_method_fast_len
</span></span><span style="display:flex;"><span>_pycc_method_fast_rev
</span></span><span style="display:flex;"><span>_pycc_method_fast_xor
</span></span></code></pre></div><p>Just by glancing at one of them, I know that I need to set up debugger environment because there&rsquo;s no way I&rsquo;m able to reverse these codes by looking and reading them. In order to do this, I use <code>Ubuntu 22.04</code> (because it already has Python 3.10 for us) to run <code>main.py</code>. While the program is waiting for our input, I use a debugger to attach to the python process that&rsquo;s running our <code>main.py</code>:</p>
<p><img src="https://i.imgur.com/tWrt6AR.png" alt=""></p>
<p>In IDA, to attach to a process, go to <code>Debugger -&gt; Attach to Process...</code> and choose a desired process to attach:</p>
<p><img src="https://i.imgur.com/bSQbs8F.png" alt=""></p>
<p>After going through all five functions, I quickly realize that only <code>_pycc_method_aes_encrypt</code> is being used &ldquo;properly&rdquo;, other four will quickly return after being called and almost doing nothing. So I shift my focus to only this function.</p>
<h2 id="analyzing-encryption-routine">Analyzing encryption routine</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">_pycc_method_aes_encrypt</span>(<span style="color:#66d9ef">__int64</span> a1, <span style="color:#66d9ef">__int64</span> a2)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">PyArg_UnpackTuple</span>(a2, <span style="color:#e6db74">&#34;aes_encrypt&#34;</span>, <span style="color:#ae81ff">3LL</span>, <span style="color:#ae81ff">3LL</span>, <span style="color:#f92672">&amp;</span>v22, <span style="color:#f92672">&amp;</span>v21, <span style="color:#f92672">&amp;</span>v20);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)<span style="color:#a6e22e">NRT_adapt_ndarray_from_python</span>(v22, <span style="color:#f92672">&amp;</span>v16) <span style="color:#f92672">||</span> <span style="color:#f92672">*</span>((_QWORD <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v17 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">1LL</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PyErr_SetString</span>(
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">&amp;</span>PyExc_TypeError,
</span></span><span style="display:flex;"><span>      <span style="color:#e6db74">&#34;can&#39;t unbox array from PyObject into native value.  The object maybe of a different type&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> __main__<span style="color:#f92672">::</span>aes_encrypt[abi:v753][abi:c8tJTC_2fWQESiLSjagd4uKgGzNAE_3d](
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&amp;</span>v13,
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">&amp;</span>v15,
</span></span><span style="display:flex;"><span>         v3,
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">*</span>((<span style="color:#66d9ef">__int64</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v3 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>         v4,
</span></span><span style="display:flex;"><span>         <span style="color:#ae81ff">1LL</span>,
</span></span><span style="display:flex;"><span>         v5,
</span></span><span style="display:flex;"><span>         <span style="color:#f92672">*</span>((<span style="color:#66d9ef">__int64</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>v5 <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>         v6);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><p><code>PyArg_UnpackTuple</code> will try to receive all arguments that&rsquo;s being passed in <code>main.py</code>, then <code>NRT_adapt_ndarray_from_python</code> will get actual values from one of the arguments and store in memories, finally <code>__main__::aes_encrypt[abi:v753][abi:c8tJTC_2fWQESiLSjagd4uKgGzNAE_3d]</code>, the main implementation of our exported aes function, will be executed. While debugging this, I notice that all arguments that&rsquo;s being passed to <code>__main__::aes_encrypt[abi:v753][abi:c8tJTC_2fWQESiLSjagd4uKgGzNAE_3d]</code> are only our input and its metadata, which means other arguments <code>KEY</code> and <code>IV</code> that are being used in the python file are garbish and used as a decoy.</p>
<p>Digging deeper in our <code>aes_encrypt</code>, I started to see some confused naming like <code>wmemchr3</code>, <code>atexit3</code>, <code>swprintf2</code>,&hellip; And if you tried to check these functions, there will be more and more confused functions just like those. Despite being weirdly named, these functions are actually being used to do encryption on our input. Also because there&rsquo;re so many functions, I have to debug and take notes so I can progress faster.</p>
<p>I spent around 1-2 hours debugging and observing memories to grasp the basic idea of the encryption routine, and to save some time for readers, I will summarize the flow in following bullet points:</p>
<ul>
<li>It creates a 256 bytes array with static values</li>
<li>Combining above array to start encrypting our input in 16 rounds, each round will encrypt our input 16 times. While this is happening, it also modifies the above array.</li>
<li>Finally it applies the encryption one more time to each characters of our input and compare the result to a fixed byte array of size 64 bytes.</li>
<li>Note: Instead of using iteration to make the encryption process looks pretty, author decided to create unique functions for each iteration. So instead of using a loop and calling just one function, the program will call nth unique functions if it loops nth time. As a result, the program doesn&rsquo;t look nice at all and debug this is pure pain.</li>
</ul>
<p>I&rsquo;m a total noob at crypto so the above idea may not match the intention of author&rsquo;s algorithm, but at least I managed to use those ideas to solve this challenge.</p>
<h2 id="recreate-programs-flow-in-python">Recreate program&rsquo;s flow in Python</h2>
<p>While I was solving this challenge and coming to this step, I had already passed half of the contest time and I was at the bottom of the scoreboard, I knew I had to quickly finish this step because this is the most important and frustrating step in this whole challenge. Then I came up with an approach: Instead of trying to recreate everything exactly like the binary, I&rsquo;ll try to extract every values that <strong>only</strong> interact with our input and recreate the program by using these values.</p>
<p>For example if an encryption flow (of course I make this up completely) works like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">encryption</span>(input, table):
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ....</span>
</span></span><span style="display:flex;"><span>    table[i] <span style="color:#f92672">=</span> table[table[j]]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ....</span>
</span></span><span style="display:flex;"><span>    input[i] <span style="color:#f92672">=</span> (input[i] <span style="color:#f92672">+</span> table[i]) <span style="color:#f92672">^</span> (input[i] <span style="color:#f92672">-</span> table[i])
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ....</span>
</span></span><span style="display:flex;"><span>    table[table[i]] <span style="color:#f92672">=</span> table[j]
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># ....</span>
</span></span></code></pre></div><p>You can notice that it&rsquo;ll swap values in <code>table</code> and apply them to our input, if we somehow knew the exact value of <code>table[i]</code> right before applying them to <code>input</code>, we just simply don&rsquo;t care about what&rsquo;s happening to <code>table</code> anymore. This will help me to reduce the amount of mistakes I make while reversing and reimplementing this code and save a lot of time if the binary I&rsquo;m working is big.</p>
<p>So I need to identify which values I need to extract. Looking at <code>aes_encrypt</code> function again, I notice there&rsquo;s a piece of code that interact directly with my input:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">func</span>(...) {
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  v25 <span style="color:#f92672">=</span> a9 <span style="color:#f92672">*</span> indexing;
</span></span><span style="display:flex;"><span>  v26 <span style="color:#f92672">=</span> table[v25];
</span></span><span style="display:flex;"><span>  v27 <span style="color:#f92672">=</span> v26 <span style="color:#f92672">+</span> a25 <span style="color:#f92672">+</span> zero_arrays_idk[indexing <span style="color:#f92672">*</span> a16];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v27 <span style="color:#f92672">!=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)indexing )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v28 <span style="color:#f92672">=</span> v27 <span style="color:#f92672">*</span> a9;
</span></span><span style="display:flex;"><span>    v29 <span style="color:#f92672">=</span> table[v28] <span style="color:#f92672">^</span> v26;
</span></span><span style="display:flex;"><span>    table[v25] <span style="color:#f92672">=</span> v29;
</span></span><span style="display:flex;"><span>    v30 <span style="color:#f92672">=</span> table[v28] <span style="color:#f92672">^</span> v29;
</span></span><span style="display:flex;"><span>    table[v28] <span style="color:#f92672">=</span> v30;
</span></span><span style="display:flex;"><span>    table[v25] <span style="color:#f92672">^=</span> v30;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  first_index <span style="color:#f92672">=</span> a23 <span style="color:#f92672">*</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)indexing <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  second_index <span style="color:#f92672">=</span> a23 <span style="color:#f92672">*</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)v27 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">2</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( (indexing <span style="color:#f92672">^</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)v27) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v35 <span style="color:#f92672">=</span> input[second_index];
</span></span><span style="display:flex;"><span>    v33 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>input[second_index];
</span></span><span style="display:flex;"><span>    v34 <span style="color:#f92672">=</span> input[first_index] <span style="color:#f92672">^</span> v35;
</span></span><span style="display:flex;"><span>    input[first_index] <span style="color:#f92672">=</span> v34;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    v33 <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>input[second_index];
</span></span><span style="display:flex;"><span>    v34 <span style="color:#f92672">=</span> input[first_index];
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  input[first_index] <span style="color:#f92672">=</span> indexing <span style="color:#f92672">^</span> v34;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>v33 <span style="color:#f92672">^=</span> v27;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>a1 <span style="color:#f92672">=</span> v27;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can see that there&rsquo;re 2 parts in this code, this first part is table swapping and the second part is applying those changes to our input. So all I really care are <code>first_index</code>, <code>second_index</code> and <code>v27</code> because only these variables access my <code>input</code> and change values in it.</p>
<p>To extract these values, we will need a debugger to do this dynamically since we need to access the memory to get those values. Again, using my favorite debugger IDA, I manage to extract those 3 arrays with the following script using IDAPython plugin:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#75715e"># I turned off ASLR in my VM so I can work on this script</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># constantly without having to change the address everytime</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># the debugger starts again.</span>
</span></span><span style="display:flex;"><span>add_bpt(<span style="color:#ae81ff">0x7FFFF6863D13</span>, <span style="color:#ae81ff">0</span>, BPT_SOFT)    <span style="color:#75715e"># &lt;-- Base address: 0x29D17</span>
</span></span><span style="display:flex;"><span>enable_bpt(<span style="color:#ae81ff">0x7FFFF6863D13</span>, <span style="color:#66d9ef">True</span>)    <span style="color:#75715e"># &lt;-- Base address: 0x29D17</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>start <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x7FFFF6886C5E</span>  <span style="color:#75715e"># &lt;-- Base address: 0x4CC5E</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>v27_array <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>first_index <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>second_index <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> _ <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">16</span>):
</span></span><span style="display:flex;"><span>        address <span style="color:#f92672">=</span> start <span style="color:#f92672">+</span> (i <span style="color:#f92672">*</span> <span style="color:#ae81ff">192</span>)
</span></span><span style="display:flex;"><span>        addr_first_idx <span style="color:#f92672">=</span> (start <span style="color:#f92672">+</span> <span style="color:#ae81ff">53</span>) <span style="color:#f92672">+</span> (i <span style="color:#f92672">*</span> <span style="color:#ae81ff">192</span>)
</span></span><span style="display:flex;"><span>        addr_seccond_idx <span style="color:#f92672">=</span> (start <span style="color:#f92672">+</span> <span style="color:#ae81ff">61</span>) <span style="color:#f92672">+</span> (i <span style="color:#f92672">*</span> <span style="color:#ae81ff">192</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(hex(address), hex(addr_first_idx), hex(addr_seccond_idx))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        add_bpt(address, <span style="color:#ae81ff">0</span>, BPT_SOFT)
</span></span><span style="display:flex;"><span>        enable_bpt(address, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        add_bpt(addr_first_idx, <span style="color:#ae81ff">0</span>, BPT_SOFT)
</span></span><span style="display:flex;"><span>        enable_bpt(addr_first_idx, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        add_bpt(addr_seccond_idx, <span style="color:#ae81ff">0</span>, BPT_SOFT)
</span></span><span style="display:flex;"><span>        enable_bpt(addr_seccond_idx, <span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        idaapi<span style="color:#f92672">.</span>continue_process()
</span></span><span style="display:flex;"><span>        idaapi<span style="color:#f92672">.</span>wait_for_next_event(WFNE_SUSP, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        v27_array<span style="color:#f92672">.</span>append(get_reg_value(<span style="color:#e6db74">&#39;r11&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        idaapi<span style="color:#f92672">.</span>continue_process()
</span></span><span style="display:flex;"><span>        idaapi<span style="color:#f92672">.</span>wait_for_next_event(WFNE_SUSP, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        first_index<span style="color:#f92672">.</span>append(get_reg_value(<span style="color:#e6db74">&#39;rcx&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        idaapi<span style="color:#f92672">.</span>continue_process()
</span></span><span style="display:flex;"><span>        idaapi<span style="color:#f92672">.</span>wait_for_next_event(WFNE_SUSP, <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        second_index<span style="color:#f92672">.</span>append(get_reg_value(<span style="color:#e6db74">&#39;rsi&#39;</span>))
</span></span><span style="display:flex;"><span>    start <span style="color:#f92672">-=</span> <span style="color:#ae81ff">5952</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(v27_array)
</span></span><span style="display:flex;"><span>print(first_index)
</span></span><span style="display:flex;"><span>print(second_index)
</span></span></code></pre></div><p>Another piece of code where it applies changes to my input:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">func</span>(
</span></span><span style="display:flex;"><span>        _QWORD <span style="color:#f92672">*</span>a1,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">__int64</span> a2,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> a3,
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">char</span> a4)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>a1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5889</span> <span style="color:#f92672">*</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(a3 <span style="color:#f92672">^</span> a4) <span style="color:#f92672">+</span> <span style="color:#ae81ff">2LL</span> <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(a3 <span style="color:#f92672">&amp;</span> a4)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">3584</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Later <code>a1</code> will assign to <code>input</code>, <code>a3</code> and <code>a4</code> are come from this function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">func</span>(...)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  constant_index <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(a10 <span style="color:#f92672">+</span> <span style="color:#ae81ff">5</span>);
</span></span><span style="display:flex;"><span>  v14 <span style="color:#f92672">=</span> table[one_value <span style="color:#f92672">*</span> constant_index];
</span></span><span style="display:flex;"><span>  table_related_index <span style="color:#f92672">=</span> a12 <span style="color:#f92672">+</span> table[one_value <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(a11 <span style="color:#f92672">+</span> v14)];
</span></span><span style="display:flex;"><span>  v16 <span style="color:#f92672">=</span> one_value <span style="color:#f92672">*</span> table_related_index;
</span></span><span style="display:flex;"><span>  v17 <span style="color:#f92672">=</span> table[v16];
</span></span><span style="display:flex;"><span>  v18 <span style="color:#f92672">=</span> v17 <span style="color:#f92672">+</span> constant_index <span style="color:#f92672">+</span> a12;
</span></span><span style="display:flex;"><span>  table[one_value <span style="color:#f92672">*</span> constant_index] <span style="color:#f92672">=</span> v17;
</span></span><span style="display:flex;"><span>  table[v16] <span style="color:#f92672">=</span> v14;
</span></span><span style="display:flex;"><span>  v19 <span style="color:#f92672">=</span> table[one_value
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(table[one_value
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(constant_index <span style="color:#f92672">+</span> table[one_value <span style="color:#f92672">*</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)(v18 <span style="color:#f92672">+</span> a13)])]
</span></span><span style="display:flex;"><span>                              <span style="color:#f92672">+</span> table_related_index)];
</span></span><span style="display:flex;"><span>  a1[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> v18;
</span></span><span style="display:flex;"><span>  a1[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">=</span> table_related_index;
</span></span><span style="display:flex;"><span>  a1[<span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> constant_index;
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">*</span>(_BYTE <span style="color:#f92672">*</span>)a1 <span style="color:#f92672">=</span> v19;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Again, this function only swaps values in <code>table</code>, so we just need to extract those 2 values and apply them to our <code>input</code>. But somehow my brain suddenly shut down at that time and I decided to implement the whole table swapping function&hellip;</p>
<p>Anyways, I finished my script on time, and it worked flawlessly. Here&rsquo;s my <a href="https://raw.githubusercontent.com/MochiNishimiya/mochinishimiya.github.io/main/challenges/ACSC_2023/encrypting.py">encryption script</a> that I reimplemented in python.</p>
<h2 id="decrypting-and-getting-flag">Decrypting and getting flag</h2>
<p>Decrypting the flag is relatively easy, as we just need to run everything backward and it should yields the flag. There&rsquo;s a note is that in this equation:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>inp[i] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">5889</span> <span style="color:#f92672">*</span> (((inp[i] <span style="color:#f92672">^</span> v19) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> ((v19 <span style="color:#f92672">&amp;</span> inp[i]) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>)) <span style="color:#f92672">+</span> <span style="color:#ae81ff">3584</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xff</span>
</span></span></code></pre></div><p>We can&rsquo;t simply reverse all operations to find old <code>inp[i]</code>, but we can bruteforce all printable characters, apply to the above equation and see if the result is equal to encrypted buffer. This way we can recover original <code>inp[i]</code>. Here&rsquo;s my <a href="https://github.com/MochiNishimiya/mochinishimiya.github.io/raw/main/challenges/ACSC_2023/decrypting.py">decrypting script</a>.</p>
<p><code>ACSC{pyth0n_numb4_0n3___s0_m4ny_functi0ns_s0_l1ttl3_us3ful_c0d3}</code></p>
<h1 id="snake-5-solves">snake (5 solves)</h1>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>Classic snake game. Score more than 31337 points and you will get the flag.
</span></span></code></pre></div><p>Given file: <a href="https://github.com/MochiNishimiya/mochinishimiya.github.io/raw/main/challenges/ACSC_2023/snake.tar.gz">snake.tar.gz</a></p>
<h2 id="initial-analysis">Initial analysis</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> a1, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a2, <span style="color:#66d9ef">char</span> <span style="color:#f92672">**</span>a3)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  __pid_t v4; <span style="color:#75715e">// [rsp+Ch] [rbp-4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fork</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v4 <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( v4 )                                     <span style="color:#75715e">// parrent proc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  {
</span></span><span style="display:flex;"><span>    pid <span style="color:#f92672">=</span> v4;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">signal</span>(<span style="color:#ae81ff">2</span>, handler);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">parrent_proc</span>();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">else</span>                                          <span style="color:#75715e">// child proc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">ptrace</span>(PTRACE_TRACEME, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1LL</span>;
</span></span><span style="display:flex;"><span>    ((<span style="color:#66d9ef">void</span> (<span style="color:#f92672">*</span>)(<span style="color:#66d9ef">void</span>))loc_401A5E)();
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0LL</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Starting at main, you can see that it&rsquo;ll call <code>fork</code> and <code>ptrace</code>, and there&rsquo;re many more <code>ptrace</code> if we dig deep down in <code>parrent_proc</code> function. At this point there&rsquo;s no doubt that this is a <code>nanomite</code> challenge. <code>Nanomite</code> technique is not a new trick in any CTFs, but for sure it&rsquo;s one of the most interesting and obnoxious technique to deal with. Basically in this kind of challenge, a process will fork itself into two processes: parent and child, the parent process will then use <code>ptrace</code> to attach to the child one, which makes it impossible to attach our debugger to observe the child one.</p>
<p>In this binary, the child process will go through garbish code that&rsquo;s going to raise exception:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">cs</span>:<span style="color:#66d9ef">dword_44A164</span>    <span style="color:#75715e">; Address at 0x401B1F
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">test</span>    <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_401B55</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">0x1010</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ud2</span>     <span style="color:#75715e">; &lt;-- Raise SIGILL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">; ---------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">db</span>    <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">ADh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">F5h</span>
</span></span></code></pre></div><p>When this happen, the flow will transfer to the process whom attach to our child to handle, in this case it&rsquo;s our parent process. Looking at parent&rsquo;s code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">parrent_proc</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v1; <span style="color:#75715e">// [rsp+4h] [rbp-10Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> stat_loc; <span style="color:#75715e">// [rsp+Ch] [rbp-104h] OVERLAPPED BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  user_regs_struct register_1; <span style="color:#75715e">// [rsp+10h] [rbp-100h] BYREF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> rdx; <span style="color:#75715e">// [rsp+F4h] [rbp-1Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> rcx; <span style="color:#75715e">// [rsp+F8h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span> rbx; <span style="color:#75715e">// [rsp+FCh] [rbp-14h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> rax; <span style="color:#75715e">// [rsp+100h] [rbp-10h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> v8; <span style="color:#75715e">// [rsp+10Ch] [rbp-4h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">wait</span>((__WAIT_STATUS)<span style="color:#f92672">&amp;</span>stat_loc);
</span></span><span style="display:flex;"><span>  v8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)stat_loc;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int8</span>)stat_loc <span style="color:#f92672">!=</span> <span style="color:#ae81ff">127</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( (stat_loc <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7F</span>) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">exit</span>(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ptrace</span>(PTRACE_GETREGS, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, <span style="color:#ae81ff">0LL</span>, <span style="color:#f92672">&amp;</span>register_1);
</span></span><span style="display:flex;"><span>    rax <span style="color:#f92672">=</span> register_1.rax;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( register_1.rax <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_19;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>LABEL_19:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( register_1.rax <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0xFFF</span> <span style="color:#f92672">&amp;&amp;</span> register_1.rax <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x2FFF</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">sub_442109</span>((<span style="color:#66d9ef">__int64</span>)<span style="color:#f92672">&amp;</span>register_1);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_22;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>LABEL_22:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">end_loop</span>(<span style="color:#f92672">&amp;</span>register_1);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wait</span>((__WAIT_STATUS)<span style="color:#f92672">&amp;</span>stat_loc);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>First it&rsquo;ll wait for our child process to change its state:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>A state change is considered to be: 
</span></span><span style="display:flex;"><span>    + The child terminated; 
</span></span><span style="display:flex;"><span>    + The child was stopped by a signal; 
</span></span><span style="display:flex;"><span>    + Or the child was resumed by a signal
</span></span></code></pre></div><p>In this case it was stopped by signal SIGILL, notice that before child steps to <code>ud2</code> instruction, it moves <code>0x1010</code> to <code>eax</code>, after that the process will then handle this by getting child&rsquo;s register states first:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">ptrace</span>(PTRACE_GETREGS, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, <span style="color:#ae81ff">0LL</span>, <span style="color:#f92672">&amp;</span>register_1);
</span></span></code></pre></div><p>Looking at the document:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>PTRACE_GETREGS:
</span></span><span style="display:flex;"><span>    Copy the tracee&#39;s general-purpose or floating-point registers, respectively, 
</span></span><span style="display:flex;"><span>    to the address data in the tracer
</span></span></code></pre></div><p>In this case <code>register_1</code> will hold every values of child&rsquo;s register. The parent&rsquo;s then going to look at the value of child&rsquo;s <code>rax</code> and decide which path it&rsquo;s going to take from there. Looking at the child&rsquo;s code where it first raises <code>SIGILL</code> again, there&rsquo;s no legit code after <code>mov eax, 0x1010</code> instruction, so how does it continue executing from there? The answer is that the parent will change those rubbish bytes to a nice looking code and modify child&rsquo;s flow by changing its <code>rip</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>_BYTE <span style="color:#f92672">*</span><span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_440514</span>(user_regs_struct <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+18h] [rbp-8h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( a1<span style="color:#f92672">-&gt;</span>rax <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0x1010</span> )
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">sub_44067C</span>(a1);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ptrace</span>(PTRACE_POKETEXT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, a1<span style="color:#f92672">-&gt;</span>rip, <span style="color:#ae81ff">0x9090909090909090LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ptrace</span>(PTRACE_PEEKTEXT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, a1<span style="color:#f92672">-&gt;</span>rip, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  v2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptrace</span>(PTRACE_PEEKTEXT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, a1<span style="color:#f92672">-&gt;</span>rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ptrace</span>(PTRACE_POKETEXT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, a1<span style="color:#f92672">-&gt;</span>rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">8</span>, v2 <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1709CE54C4D832ADLL</span>);
</span></span><span style="display:flex;"><span>  v3 <span style="color:#f92672">=</span> <span style="color:#a6e22e">ptrace</span>(PTRACE_PEEKTEXT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, a1<span style="color:#f92672">-&gt;</span>rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">0LL</span>) <span style="color:#f92672">^</span> <span style="color:#ae81ff">0x3BED09CED801B4A8LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (_BYTE <span style="color:#f92672">*</span>)<span style="color:#a6e22e">ptrace</span>(PTRACE_POKETEXT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, a1<span style="color:#f92672">-&gt;</span>rip <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>, v3);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_4026DF</span>(user_regs_struct <span style="color:#f92672">*</span>a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  a1<span style="color:#f92672">-&gt;</span>rip <span style="color:#f92672">+=</span> <span style="color:#ae81ff">2LL</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ptrace</span>(PTRACE_SETREGS, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, <span style="color:#ae81ff">0LL</span>, a1);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ptrace</span>(PTRACE_CONT, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)pid, <span style="color:#ae81ff">0LL</span>, <span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>One of the most common first step to handle <code>nanomite</code> challenges is to fix child&rsquo;s code so that we can statically analyze it, and there&rsquo;s a neat trick for this.</p>
<h2 id="ld_preload-trick-and-further-analysis">LD_PRELOAD trick and further analysis</h2>
<p>In order for parent process to modify child&rsquo;s code, it must call <code>ptrace</code> with argument <code>PTRACE_POKETEXT</code> or <code>PTRACE_POKEDATA</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>PTRACE_POKETEXT, PTRACE_POKEDATA:
</span></span><span style="display:flex;"><span>Copy the word data to the address addr in the tracee&#39;s memory
</span></span></code></pre></div><p>And what <code>LD_PRELOAD</code> trick can do is it will load a custom shared library first by specifying a path to the shared library you want to load in an environment variable called <code>LD_PRELOAD</code>. When you defined an exported symbol like <code>malloc</code> for example, instead of calling <code>malloc</code> in <code>libc.so</code> file, it&rsquo;ll instead call <code>malloc</code> from our library, which we can do things like inspecting arguments, changing how malloc works&hellip;</p>
<p>Combining two above information, the general idea is that we want to hook <code>ptrace</code> using <code>LD_PRELOAD</code> and inspect its arguments. If there&rsquo;s <code>PTRACE_POKETEXT</code> specified in the first argument of <code>ptrace</code>, we can retreive datas and address where it&rsquo;s going to patch in the child code. More information about this technique can be found in this excellent <a href="https://lkmidas.github.io/posts/20210201-justctf2020-writeups/#debug_me_if_you_can">blog</a>.</p>
<p>I also used the hook code in mentioned blog and modified a little bit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define _GNU_SOURCE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;dlfcn.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/ptrace.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/types.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdarg.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/utsname.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;sys/stat.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>FILE<span style="color:#f92672">*</span> pFile2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> <span style="color:#a6e22e">ptrace</span>(<span style="color:#66d9ef">enum</span> __ptrace_request __request, ...){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pid_t</span> caller <span style="color:#f92672">=</span> <span style="color:#a6e22e">getpid</span>();
</span></span><span style="display:flex;"><span>    va_list list;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">va_start</span>(list, __request);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">pid_t</span> pid <span style="color:#f92672">=</span> <span style="color:#a6e22e">va_arg</span>(list, <span style="color:#66d9ef">pid_t</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> addr <span style="color:#f92672">=</span> <span style="color:#a6e22e">va_arg</span>(list, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> data <span style="color:#f92672">=</span> <span style="color:#a6e22e">va_arg</span>(list, <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> (<span style="color:#f92672">*</span>orig_ptrace)(<span style="color:#66d9ef">enum</span> __ptrace_request __request, <span style="color:#66d9ef">pid_t</span> pid, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>addr, <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>data);
</span></span><span style="display:flex;"><span>    orig_ptrace <span style="color:#f92672">=</span> <span style="color:#a6e22e">dlsym</span>(RTLD_NEXT, <span style="color:#e6db74">&#34;ptrace&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> <span style="color:#a6e22e">orig_ptrace</span>(__request, pid, addr, data);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (__request <span style="color:#f92672">==</span> PTRACE_POKETEXT){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fprintf</span>(pFile2, <span style="color:#e6db74">&#34;(0x%lx , 0x%lx),</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)addr, (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span>)data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">__attribute__</span>((constructor)) <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setup</span>(<span style="color:#66d9ef">void</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;hello</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    pFile2 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(<span style="color:#e6db74">&#34;./log.txt&#34;</span>, <span style="color:#e6db74">&#34;a&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Compile with command:</p>
<p><code>gcc -shared -fPIC ptrace_hook.c -ldl -o ptrace_hook.so</code></p>
<p>Start the game with this command:</p>
<p><code>LD_PRELOAD=./ptrace_hook.so ./snake</code></p>
<p>And after playing the game for a while, the result should look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fallback" data-lang="fallback"><span style="display:flex;"><span>(0x401471 , 0x4900f058b9090),
</span></span><span style="display:flex;"><span>(0x40159d , 0x9090909090909090),
</span></span><span style="display:flex;"><span>(0x4015a5 , 0x25b9ba0000201ab8),
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>(0x401830 , 0x9090909090909090),
</span></span><span style="display:flex;"><span>(0x401838 , 0xe9a9ba00002071b8),
</span></span><span style="display:flex;"><span>(0x401849 , 0x4c0589e4458b9090),
</span></span></code></pre></div><p>I copy this array and apply patches to <code>snake</code> using python script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>li <span style="color:#f92672">=</span> [(<span style="color:#ae81ff">0x401471</span> , <span style="color:#ae81ff">0x4900f058b9090</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">0x40159d</span> , <span style="color:#ae81ff">0x9090909090909090</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">0x4015a5</span> , <span style="color:#ae81ff">0x25b9ba0000201ab8</span>),
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ....</span>
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">0x401830</span> , <span style="color:#ae81ff">0x9090909090909090</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">0x401838</span> , <span style="color:#ae81ff">0xe9a9ba00002071b8</span>),
</span></span><span style="display:flex;"><span>(<span style="color:#ae81ff">0x401849</span> , <span style="color:#ae81ff">0x4c0589e4458b9090</span>)]
</span></span><span style="display:flex;"><span>bin <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;./snake&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> cmd <span style="color:#f92672">in</span> li:
</span></span><span style="display:flex;"><span>    addr, data <span style="color:#f92672">=</span> cmd
</span></span><span style="display:flex;"><span>    addr <span style="color:#f92672">-=</span> <span style="color:#ae81ff">0x400000</span>
</span></span><span style="display:flex;"><span>    bin <span style="color:#f92672">=</span> bin[:addr] <span style="color:#f92672">+</span> p64(data) <span style="color:#f92672">+</span> bin[addr<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>open(<span style="color:#e6db74">&#39;./new_snake&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>)<span style="color:#f92672">.</span>write(bin)
</span></span></code></pre></div><p>This will create a new binary name <code>new_snake</code> with a completely fixed child&rsquo;s code (although you can see there will be some of the code that can&rsquo;t be disassembled, this is because the parent fixes <code>rip</code> to jump over those malformed bytes).</p>
<p>Now looking at the parent&rsquo;s code again:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">parrent_proc</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span> ( <span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// ....
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    rax <span style="color:#f92672">=</span> register_1.rax;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( register_1.rax <span style="color:#f92672">==</span> <span style="color:#ae81ff">4</span> )  <span style="color:#75715e">// [4]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    {
</span></span><span style="display:flex;"><span>        rbx <span style="color:#f92672">=</span> register_1.rbx;   <span style="color:#75715e">// score
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        rcx <span style="color:#f92672">=</span> register_1.rcx;   <span style="color:#75715e">// height
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        rdx <span style="color:#f92672">=</span> register_1.rdx;   <span style="color:#75715e">// width
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">LODWORD</span>(register_1.rbx) )
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sub_402248</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">sub_4024A9</span>(rbx, rcx, rdx);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">puts</span>(<span style="color:#e6db74">&#34;At least try to get 1 point?...&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">goto</span> endloop;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">4</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">goto</span> LABEL_19;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">!=</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">3</span> )
</span></span><span style="display:flex;"><span>      {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> )     <span style="color:#75715e">// [1]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          time_stamp <span style="color:#f92672">=</span> <span style="color:#a6e22e">time</span>(<span style="color:#ae81ff">0LL</span>);
</span></span><span style="display:flex;"><span>          register_1.rax <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)time_stamp;
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">goto</span> endloop;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ( rax <span style="color:#f92672">==</span> <span style="color:#ae81ff">2</span> )     <span style="color:#75715e">// [2]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        {
</span></span><span style="display:flex;"><span>          <span style="color:#a6e22e">usleep</span>(<span style="color:#ae81ff">0x4E20u</span>);
</span></span><span style="display:flex;"><span>          <span style="color:#66d9ef">goto</span> endloop;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>      }
</span></span><span style="display:flex;"><span>LABEL_19:
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">if</span> ( register_1.rax <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0xFFF</span> <span style="color:#f92672">&amp;&amp;</span> register_1.rax <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0x2FFF</span> )
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// [5]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// [3]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    v1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">__PAIR64__</span>(register_1.rcx, register_1.rbx);    <span style="color:#75715e">// Food&#39;s coordinate
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span>v8 )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_4020DA</span>();
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_4020FC</span>();
</span></span><span style="display:flex;"><span>      v8 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sub_40212D</span>(v1)
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As already mentioned, the parent code will decide which path it&rsquo;s going to take based on the value of <code>rax</code>. You&rsquo;ll notice that there&rsquo;re only 5 branches which I comment from <code>[1]</code> to <code>[5]</code>, the 5th one will modify child&rsquo;s code, the other four are special branches that&rsquo;s going to control special variables in the game:</p>
<ul>
<li><code>[1]</code> will pass the time stamp to child process.</li>
<li><code>[2]</code> will just sleep.</li>
<li><code>[3]</code> will inital MD5 hash and update with our previous time stamp if this is the first time it hits, then it will update the hash using coordinates of the food that&rsquo;s being eaten by the snake.</li>
<li><code>[4]</code> will get our score, screen&rsquo;s width and screen&rsquo;s height, final updates for MD5 hash using <code>.text</code> section of child&rsquo;s process and then it will create a packet that&rsquo;s going to be sent to server with the following address <code>snake.chal.ctf.acsc.asia:4444</code></li>
</ul>
<p>The packet has the following syntax:</p>
<p><code>p32(time_stamp) + p32(width) + p32(height) + p32(score) + MD5 hash</code></p>
<p>And the MD5 will be created as:</p>
<p><code>hash = MD5(time_stamp + all food's coordinate + child's .text section)</code></p>
<h2 id="analyzing-packets-components">Analyzing packet&rsquo;s components</h2>
<p>We already had <code>time_stamp</code> in <code>[1]</code>, <code>.text</code> section of child process can be achieved by getting all the bytes from <code>new_snake</code> with following IDA script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>start <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x401280</span>
</span></span><span style="display:flex;"><span>length <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x442FCE</span> <span style="color:#f92672">-</span> start
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(idaapi<span style="color:#f92672">.</span>get_bytes(start, length))
</span></span></code></pre></div><p>And how about food&rsquo;s coordinate? Because we need to get a score of 31338 to beat the game, we&rsquo;ll need at least 31338 food&rsquo;s positions to create a valid packet. So we need to find the code where it generates these foods.</p>
<p>This is where the appearance of <code>time_stamp</code> takes in place. I highly suspect that all the food will be generated with an algorithm where <code>time_stamp</code> is a random seed, so I look back at child&rsquo;s code to trace every references of <code>time_stamp</code> and stumble upon this code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__int64</span> <span style="color:#66d9ef">__fastcall</span> <span style="color:#a6e22e">sub_442AD1</span>(<span style="color:#66d9ef">__int64</span> a1)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">__int64</span> result; <span style="color:#75715e">// rax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  qword_44ACC0[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> a1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span> ( dword_44A3C0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; ; <span style="color:#f92672">++</span>dword_44A3C0 )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    result <span style="color:#f92672">=</span> (<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">int</span>)dword_44A3C0;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( dword_44A3C0 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">311</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>    qword_44ACC0[dword_44A3C0] <span style="color:#f92672">=</span> dword_44A3C0
</span></span><span style="display:flex;"><span>                               <span style="color:#f92672">-</span> <span style="color:#ae81ff">8612607789318272311LL</span>
</span></span><span style="display:flex;"><span>                               <span style="color:#f92672">*</span> (qword_44ACC0[dword_44A3C0 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)qword_44ACC0[dword_44A3C0 <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">62</span>));
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Next I try to find all codes that has <code>qword_44ACC0</code> or <code>dword_44A3C0</code> apperances and again stumble upon this following code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> <span style="color:#a6e22e">sub_442BF8</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> v0; <span style="color:#75715e">// eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v2; <span style="color:#75715e">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v3; <span style="color:#75715e">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v4; <span style="color:#75715e">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span> v5; <span style="color:#75715e">// [rsp+0h] [rbp-18h]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span> i; <span style="color:#75715e">// [rsp+Ch] [rbp-Ch]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( dword_44A3C0 <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">311</span> )
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ( dword_44A3C0 <span style="color:#f92672">==</span> <span style="color:#ae81ff">313</span> )
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">sub_442AD1</span>(<span style="color:#ae81ff">5489LL</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> ( i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>; i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">155</span>; <span style="color:#f92672">++</span>i )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v2 <span style="color:#f92672">=</span> qword_44ACC0[i] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF80000000LL</span> <span style="color:#f92672">|</span> qword_44ACC0[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFFFF</span>;
</span></span><span style="display:flex;"><span>      qword_44ACC0[i] <span style="color:#f92672">=</span> qword_44A3D0[v2 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> (v2 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> qword_44ACC0[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">156</span>];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> ( i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">310</span> )
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      v3 <span style="color:#f92672">=</span> qword_44ACC0[i] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF80000000LL</span> <span style="color:#f92672">|</span> qword_44ACC0[i <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFFFF</span>;
</span></span><span style="display:flex;"><span>      qword_44ACC0[i] <span style="color:#f92672">=</span> qword_44A3D0[v3 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> (v3 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> qword_44ACC0[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">156</span>];
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">++</span>i;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    qword_44B678 <span style="color:#f92672">=</span> ((qword_44B678 <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFFFFFF80000000LL</span> <span style="color:#f92672">|</span> qword_44ACC0[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7FFFFFFF</span>) <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> qword_44B198 <span style="color:#f92672">^</span> qword_44A3D0[qword_44ACC0[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>    dword_44A3C0 <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  v0 <span style="color:#f92672">=</span> dword_44A3C0<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  v4 <span style="color:#f92672">=</span> ((<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">__int64</span>)qword_44ACC0[v0] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">26</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xBBBBBBBBBBBBBBBBLL</span> <span style="color:#f92672">^</span> qword_44ACC0[v0];
</span></span><span style="display:flex;"><span>  v5 <span style="color:#f92672">=</span> (((v4 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">19</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xA82C9FFFEDA60000LL</span> <span style="color:#f92672">^</span> v4) <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">37</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFABCD000000000LL</span> <span style="color:#f92672">^</span> (v4 <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">19</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xA82C9FFFEDA60000LL</span> <span style="color:#f92672">^</span> v4;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> (v5 <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">45</span>) <span style="color:#f92672">^</span> v5;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I then looked up these constants on the internet and found out that this is <code>Mersenne Twister</code> algorithm. I quickly grabbed a C code from this <a href="http://www.math.sci.hiroshima-u.ac.jp/m-mat/MT/VERSIONS/C-LANG/mt19937-64.c">page</a>, modified constants and operations to match everything in the binary and successfully recreate every single food&rsquo;s coordinate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define NN 312
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MM 156
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MATRIX_A 0xB5026F5AA96619E9ULL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define UM 0xFFFFFFFF80000000ULL </span><span style="color:#75715e">/* Most significant 33 bits */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define LM 0x7FFFFFFFULL </span><span style="color:#75715e">/* Least significant 31 bits */</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* The array for the state vector */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> mt[NN]; 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* mti==NN+1 means mt[NN] is not initialized */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">int</span> mti<span style="color:#f92672">=</span>NN<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* initializes mt[NN] with a seed */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">init_genrand64</span>(<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> seed)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    mt[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> seed;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (mti<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>; mti<span style="color:#f92672">&lt;</span>NN; mti<span style="color:#f92672">++</span>) 
</span></span><span style="display:flex;"><span>        mt[mti] <span style="color:#f92672">=</span> mti <span style="color:#f92672">-</span> (<span style="color:#ae81ff">8612607789318272311LL</span> <span style="color:#f92672">*</span> (mt[mti<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> (mt[mti<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">62</span>)));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* generates a random number on [0, 2^64-1]-interval */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> <span style="color:#a6e22e">genrand64_int64</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> x;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span> <span style="color:#66d9ef">long</span> mag01[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0ULL</span>, MATRIX_A};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (mti <span style="color:#f92672">&gt;=</span> NN) { <span style="color:#75715e">/* generate NN words at one time */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* if init_genrand64() has not been called, */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/* a default initial seed is used     */</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (mti <span style="color:#f92672">==</span> NN<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>) 
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">init_genrand64</span>(<span style="color:#ae81ff">5489ULL</span>); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span>NN<span style="color:#f92672">-</span>MM;i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> (mt[i]<span style="color:#f92672">&amp;</span>UM)<span style="color:#f92672">|</span>(mt[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span>LM);
</span></span><span style="display:flex;"><span>            mt[i] <span style="color:#f92672">=</span> mt[i<span style="color:#f92672">+</span>MM] <span style="color:#f92672">^</span> (x<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mag01[(<span style="color:#66d9ef">int</span>)(x<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1ULL</span>)];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> (;i<span style="color:#f92672">&lt;</span>NN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>            x <span style="color:#f92672">=</span> (mt[i]<span style="color:#f92672">&amp;</span>UM)<span style="color:#f92672">|</span>(mt[i<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span>LM);
</span></span><span style="display:flex;"><span>            mt[i] <span style="color:#f92672">=</span> mt[i<span style="color:#f92672">+</span>(MM<span style="color:#f92672">-</span>NN)] <span style="color:#f92672">^</span> (x<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mag01[(<span style="color:#66d9ef">int</span>)(x<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1ULL</span>)];
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        x <span style="color:#f92672">=</span> (mt[NN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]<span style="color:#f92672">&amp;</span>UM)<span style="color:#f92672">|</span>(mt[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&amp;</span>LM);
</span></span><span style="display:flex;"><span>        mt[NN<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">=</span> mt[MM<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>] <span style="color:#f92672">^</span> (x<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">1</span>) <span style="color:#f92672">^</span> mag01[(<span style="color:#66d9ef">int</span>)(x<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">1ULL</span>)];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        mti <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">=</span> mt[mti<span style="color:#f92672">++</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">^=</span> (x <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">26</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xBBBBBBBBBBBBBBBBLL</span>;
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">^=</span> (x <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">19</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xA82C9FFFEDA60000LL</span>;
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">^=</span> (x <span style="color:#f92672">&lt;&lt;</span> <span style="color:#ae81ff">37</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0xFFFABCD000000000LL</span>;
</span></span><span style="display:flex;"><span>    x <span style="color:#f92672">^=</span> (x <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">45</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> x;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">init_genrand64</span>(<span style="color:#ae81ff">0x63FA7A57</span>); <span style="color:#75715e">// time_stamp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">31338</span>; i<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%02llx &#34;</span>, <span style="color:#a6e22e">genrand64_int64</span>() <span style="color:#f92672">%</span> (<span style="color:#ae81ff">0xcb</span>  <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%02llx &#34;</span>, <span style="color:#a6e22e">genrand64_int64</span>() <span style="color:#f92672">%</span> (<span style="color:#ae81ff">0x2c</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="create-a-valid-packet">Create a valid packet</h2>
<p>Now I&rsquo;m having everything I need to create a valid packet, I randomly chose <code>0x63FA7A57</code> as a seed, <code>0xcb</code> and <code>0x2c</code> as values of width and height respectively and create 31338 food&rsquo;s positions.</p>
<p>This is my script for recreating a packet and sending to server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#f92672">import</span> hashlib
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>md5 <span style="color:#f92672">=</span> hashlib<span style="color:#f92672">.</span>md5()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>li <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0a 03 08 02 3b 04 53 19 15 1b 34 ...&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>x <span style="color:#f92672">=</span> [int(i, <span style="color:#ae81ff">16</span>) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> li<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39; &#39;</span>)]
</span></span><span style="display:flex;"><span>text_section <span style="color:#f92672">=</span> open(<span style="color:#e6db74">&#39;hehe&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>coordinates <span style="color:#f92672">=</span> <span style="color:#e6db74">b</span><span style="color:#e6db74">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>num <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> x:
</span></span><span style="display:flex;"><span>    coordinates <span style="color:#f92672">+=</span> p32(i)
</span></span><span style="display:flex;"><span>    num <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>md5<span style="color:#f92672">.</span>update(p32(<span style="color:#ae81ff">0x63FA7A57</span>))
</span></span><span style="display:flex;"><span>md5<span style="color:#f92672">.</span>update(coordinates)
</span></span><span style="display:flex;"><span>md5<span style="color:#f92672">.</span>update(text_section)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> remote(<span style="color:#e6db74">&#39;snake.chal.ctf.acsc.asia&#39;</span>, <span style="color:#ae81ff">4444</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>packet <span style="color:#f92672">=</span> p32(<span style="color:#ae81ff">0x63FA7A57</span>)	<span style="color:#75715e"># time stamp</span>
</span></span><span style="display:flex;"><span>packet <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0xcb</span>)		<span style="color:#75715e"># width</span>
</span></span><span style="display:flex;"><span>packet <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0x2c</span>)		<span style="color:#75715e"># height</span>
</span></span><span style="display:flex;"><span>packet <span style="color:#f92672">+=</span> p32(<span style="color:#ae81ff">0x7a6a</span>)	<span style="color:#75715e"># score</span>
</span></span><span style="display:flex;"><span>packet <span style="color:#f92672">+=</span> md5<span style="color:#f92672">.</span>digest()	<span style="color:#75715e"># md5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>send(packet)
</span></span><span style="display:flex;"><span>r<span style="color:#f92672">.</span>interactive()
</span></span></code></pre></div><p>After running this, we get:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>nguyenguyen753@nguyenguyen753:~/Desktop/CTF/ACSC/snake/mtwister$ python3 script.py 
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>+<span style="color:#f92672">]</span> Opening connection to snake.chal.ctf.acsc.asia on port 4444: Done
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Switching to interactive mode
</span></span><span style="display:flex;"><span><span style="color:#f92672">===</span> LEADERBOARD <span style="color:#f92672">===</span>
</span></span><span style="display:flex;"><span>1. johnwick   <span style="color:#ae81ff">31337</span>
</span></span><span style="display:flex;"><span>2. ishowsewey <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>3. vinh       <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>4. cakash     <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>5. weekek     <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Congrats! You beat the highscore!
</span></span><span style="display:flex;"><span>ACSC<span style="color:#f92672">{</span>y0u_4R3_pr0_G4m3r_Or_ch34t3R<span style="color:#f92672">}</span>
</span></span></code></pre></div><p><code>ACSC{y0u_4R3_pr0_G4m3r_Or_ch34t3R}</code></p>

		</section>

		<div class="post-tags">
			
			
			
		</div>
	</article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/mochinishimiya" title="GitHub"><i data-feather="github"></i></a>
    <a class="border"></a><a class="soc" href="https://twitter.com/MochiNishimiya" title="Twitter"><i data-feather="twitter"></i></a>
    <a class="border"></a></div>
  <div class="footer-info">
    2023  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>


<script>
  feather.replace()
</script></div>
    </body>
</html>
